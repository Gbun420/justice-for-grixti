<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - Justice for Dr. Silvio Grixti</title>
    <link rel="stylesheet" href="/src/assets/css/style.css">
    <style>
        .blog-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .post-card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .post-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        .post-meta {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }
        .post-excerpt {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .read-more {
            color: var(--secondary);
            font-weight: 600;
            text-decoration: none;
        }
        .read-more:hover {
            text-decoration: underline;
        }
        .blog-empty {
            text-align: center;
            color: #666;
            padding: 3rem;
        }
        .post-content {
            line-height: 1.7;
        }
        .post-content h1,
        .post-content h2,
        .post-content h3 {
            color: var(--primary);
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-content p {
            margin-bottom: 1rem;
        }
        .post-content ul,
        .post-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        .post-content li {
            margin-bottom: 0.5rem;
        }
        .post-content blockquote {
            border-left: 4px solid var(--secondary);
            padding-left: 1rem;
            margin: 1.5rem 0;
            font-style: italic;
            color: #555;
        }
        .post-content code {
            background: #f4f4f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">Justice for Dr. Silvio Grixti</div>
            <ul id="main-nav" class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#case">The Case</a></li>
                <li><a href="#petition">Petition</a></li>
                <li><a href="#timeline">Timeline</a></li>
                <li><a href="#contact">Contact</a></li>
                <li><a href="/blog" class="active">Blog</a></li>
            </ul>
        </nav>
    </header>

    <main class="blog-container">
        <h1>Blog & Updates</h1>
        <div id="blog-list"></div>
        <div id="blog-single" style="display:none;">
            <button id="back-to-list" class="btn-secondary">← Back to Blog</button>
            <article id="single-post-content"></article>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Justice for Dr. Silvio Grixti - A Community Initiative</p>
            <ul class="footer-links">
                <li><a href="/">Home</a></li>
                <li><a href="/#about">About Dr. Grixti</a></li>
                <li><a href="/#case">Case Information</a></li>
                <li><a href="/#petition">Petition</a></li>
                <li><a href="/#contact">Contact</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="mailto:justiceforgrixti@proton.me">Email Us</a></li>
            </ul>
        </div>
    </footer>

    <script type="module">
        const SUPABASE_URL = "https://kxanfgxohnrjgudotdyj.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4YW5mZ3hvaG5yamd1ZG90ZHlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODEwMTcsImV4cCI6MjA4NTg1NzAxN30.5dROIdm6lGXAOxhQ22GlbYv352q_1S_BHF8k6xJChgc";

        const blogList = document.getElementById("blog-list");
        const blogSingle = document.getElementById("blog-single");
        const singlePostContent = document.getElementById("single-post-content");
        const backToList = document.getElementById("back-to-list");

        // Simple markdown parser (basic)
        function parseMarkdown(md) {
            let html = md;
            // Headers
            html = html.replace(/^### (.*$)/gim, "<h3>$1</h3>");
            html = html.replace(/^## (.*$)/gim, "<h2>$1</h2>");
            html = html.replace(/^# (.*$)/gim, "<h1>$1</h1>");
            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            // Italic
            html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            // Lists
            html = html.replace(/^\* (.+)/gim, "<li>$1</li>");
            html = html.replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>");
            // Blockquotes
            html = html.replace(/^> (.+)/gim, "<blockquote>$1</blockquote>");
            // Line breaks
            html = html.replace(/\n\n/g, "</p><p>");
            html = "<p>" + html + "</p>";
            // Clean up extra tags
            html = html.replace(/<p><\/p>/g, "");
            html = html.replace(/<p>(<h[1-6]>)/g, "$1");
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, "$1");
            html = html.replace(/<p>(<ul>)/g, "$1");
            html = html.replace(/(<\/ul>)<\/p>/g, "$1");
            html = html.replace(/<p>(<blockquote>)/g, "$1");
            html = html.replace(/(<\/blockquote>)<\/p>/g, "$1");
            return html;
        }

        // Load posts
        async function loadPosts() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/posts?is_draft=eq.false&order=published_at.desc`,
                    {
                        headers: {
                            apikey: SUPABASE_ANON_KEY,
                            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                        },
                    }
                );
                if (!response.ok) throw new Error("Failed to load posts");
                const posts = await response.json();
                renderPostList(posts);
            } catch (err) {
                console.error(err);
                blogList.innerHTML = "<p>Failed to load blog posts.</p>";
            }
        }

        // Render post list
        function renderPostList(posts) {
            if (!posts.length) {
                blogList.innerHTML = '<div class="blog-empty">No blog posts yet. Check back soon!</div>';
                return;
            }
            blogList.innerHTML = posts
                .map(
                    (post) => `
                <div class="post-card">
                    <h2 class="post-title">${post.title}</h2>
                    <div class="post-meta">
                        By ${post.author} • ${new Date(
                            post.published_at
                        ).toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        })}
                    </div>
                    <div class="post-excerpt">${post.excerpt || ""}</div>
                    <a href="#" class="read-more" data-slug="${post.slug}">Read more →</a>
                </div>
            `
                )
                .join("");

            // Add click handlers
            blogList.querySelectorAll(".read-more").forEach((link) => {
                link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const slug = e.target.dataset.slug;
                    loadSinglePost(slug);
                });
            });
        }

        // Load single post
        async function loadSinglePost(slug) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/posts?slug=eq.${slug}&is_draft=eq.false`,
                    {
                        headers: {
                            apikey: SUPABASE_ANON_KEY,
                            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                        },
                    }
                );
                if (!response.ok) throw new Error("Failed to load post");
                const [post] = await response.json();
                if (!post) throw new Error("Post not found");
                renderSinglePost(post);
            } catch (err) {
                console.error(err);
                alert("Failed to load post.");
            }
        }

        // Render single post
        function renderSinglePost(post) {
            const contentHtml = parseMarkdown(post.content);
            singlePostContent.innerHTML = `
                <h1>${post.title}</h1>
                <div class="post-meta">
                    By ${post.author} • ${new Date(
                        post.published_at
                    ).toLocaleDateString("en-US", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                    })}
                </div>
                <div class="post-content">${contentHtml}</div>
            `;
            blogList.style.display = "none";
            blogSingle.style.display = "block";
        }

        // Back to list
        backToList.addEventListener("click", () => {
            blogList.style.display = "block";
            blogSingle.style.display = "none";
        });

        // Initialize
        loadPosts();
    </script>
</body>
</html>
